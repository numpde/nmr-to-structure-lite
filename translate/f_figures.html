<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Molecule Viewer</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .top-bar {
      background: #f2f2f2;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid #ddd;
    }
    .top-bar input {
      width: 80%;
      padding: 5px;
      font-size: 14px;
    }
    .top-bar button {
      padding: 5px 10px;
      font-size: 14px;
    }
    .container {
      width: 90%;
      margin: auto;
      padding: 20px 20px; /* ensure left/right padding */
    }
    .molecule-row {
      display: flex;
      flex-direction: row;
      gap: 20px;
      margin-bottom: 20px;
      padding: 10px;
      padding-right: 20px; /* add gap on right */
      border-bottom: 1px solid #ddd;
      align-items: flex-start;
    }
    .molecule-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 150px;
      cursor: pointer;
    }
    /* Each canvas is rendered with an intrinsic size of 300x300 for higher resolution, but displayed at 150x150 */
    .molecule-canvas {
      width: 150px;
      height: 150px;
    }
    .score,
    .header-text {
      font-size: 12px;
      color: gray;
      margin-bottom: 5px;
    }
    .header-text {
      font-weight: normal;
    }
    .smiles-text {
      font-size: 12px;
      margin-top: 5px;
      text-align: center;
      word-break: break-all;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <!-- Use value attribute so the default URL is visible on load -->
    <input id="dataUrlInput" type="text" value="./work/001_big/lambda/20250309-220000/translation/tgt-test_n1000.txt__model_step_250000__n_best=10__beam_size=100.txt.json" />
    <button id="loadButton">Load Data</button>
  </div>
  <div id="root"></div>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/smiles-drawer@2.0.1/dist/smiles-drawer.min.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Fallback data with simple, short SMILES.
    // (Second hyp in first entry is intentionally invalid.)
    const fallbackData = [
      {
        sent: "C 6 H 6",
        ref: "C1=CC=CC=C1",
        hyps: [
          { score: -0.1, pred: "C1=CC=CC=C1" },
          { score: -0.2, pred: "InvalidSMILES" }
        ]
      },
      {
        sent: "C 2 H 5 OH",
        ref: "CCO",
        hyps: [
          { score: -0.05, pred: "CCO" },
          { score: -0.08, pred: "C-C-O" }
        ]
      }
    ];

    // Helper: Draw an error message on a canvas.
    const drawError = (canvas, msg) => {
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.font = "14px Arial";
      ctx.fillStyle = "red";
      ctx.textAlign = "center";
      ctx.fillText(msg, canvas.width / 2, canvas.height / 2);
    };

    // MoleculeCard component: displays an optional header, score (for predictions), image, and SMILES.
    // The "correct" prop sets a thicker green border if true.
    const MoleculeCard = ({ smiles, score, isPrediction, header, canvasId, openExternalViewer, correct }) => (
      <div className="molecule-card" onClick={() => openExternalViewer(smiles)}>
        {header && <div className="header-text">{header}</div>}
        {isPrediction && !header && <div className="score">{score}</div>}
        <canvas
          id={canvasId}
          className="molecule-canvas"
          width="300" height="300"
          style={{
            border: correct ? "4px solid green" : "2px solid black",
            // Adjust position if border is thicker so images align
            marginTop: correct ? "-2px" : "0"
          }}
        ></canvas>
        <div className="smiles-text">{smiles}</div>
      </div>
    );

    function MoleculeViewer({ dataUrl }) {
      const [molecules, setMolecules] = useState([]);
      const [page, setPage] = useState(1);
      const containerRef = useRef(null);

      useEffect(() => {
        loadMolecules();
        window.addEventListener("scroll", handleScroll);
        return () => window.removeEventListener("scroll", handleScroll);
      }, [dataUrl]);

      // Load molecules from provided data URL or fallback.
      const loadMolecules = async () => {
        try {
          const response = await fetch(dataUrl);
          if (!response.ok) throw new Error("Failed to load");
          const data = await response.json();
          setMolecules(data); // store full dataset
          setPage(1);
        } catch (error) {
          console.warn("Using fallback data:", error);
          setMolecules(fallbackData);
          setPage(1);
        }
      };

      // Load 5 rows at a time.
      const handleScroll = () => {
        if (window.innerHeight + window.scrollY >= document.documentElement.scrollHeight - 100) {
          setPage(prev => prev + 1);
        }
      };

      useEffect(() => {
        if (molecules.length > 0) {
          drawMolecules();
        }
      }, [molecules, page]);

      const drawMolecules = () => {
        molecules.slice(0, page * 5).forEach((mol, index) => {
          const refSmiles = mol.ref.replace(/\s+/g, "");
          drawMolecule(`mol-ref-${index}`, refSmiles);
          // Only display first 4 hypotheses.
          mol.hyps.slice(0, 4).forEach((hyp, hIdx) => {
            const predSmiles = hyp.pred.replace(/\s+/g, "");
            drawMolecule(`mol-hyp-${index}-${hIdx}`, predSmiles);
          });
        });
      };

      const drawMolecule = (canvasId, smiles) => {
        const canvas = document.getElementById(canvasId);
        if (canvas) {
          const drawer = new SmilesDrawer.Drawer({ width: 300, height: 300 });
          SmilesDrawer.parse(
            smiles,
            (tree) => drawer.draw(tree, canvas, "light"),
            (err) => {
              console.warn("Error parsing SMILES:", smiles, err);
              drawError(canvas, "Invalid SMILES");
            }
          );
        }
      };

      // Open PubChem with the SMILES.
      const openExternalViewer = (smiles) => {
        const url = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${encodeURIComponent(smiles)}/PNG`;
        window.open(url, "_blank");
      };

      return (
        <div className="container" ref={containerRef}>
          {molecules.slice(0, page * 5).map((mol, index) => (
            <div key={index} className="molecule-row">
              {/* Reference card with header */}
              <MoleculeCard
                smiles={mol.ref.replace(/\s+/g, "")}
                header="Reference"
                canvasId={`mol-ref-${index}`}
                openExternalViewer={openExternalViewer}
              />
              {/* Prediction cards: only first 4 */}
              {mol.hyps.slice(0, 4).map((hyp, hIdx) => (
                <MoleculeCard
                  key={hIdx}
                  smiles={hyp.pred.replace(/\s+/g, "")}
                  score={hyp.score}
                  isPrediction={true}
                  canvasId={`mol-hyp-${index}-${hIdx}`}
                  openExternalViewer={openExternalViewer}
                  correct={ (hyp.pred.replace(/\s+/g, "") === mol.ref.replace(/\s+/g, "")) }
                />
              ))}
            </div>
          ))}
        </div>
      );
    }

    function App() {
      const defaultUrl = "./work/001_big/lambda/20250309-220000/translation/tgt-test_n1000.txt__model_step_250000__n_best=10__beam_size=100.txt.json";
      const [dataUrl, setDataUrl] = useState(defaultUrl);

      return (
        <MoleculeViewer dataUrl={dataUrl} />
      );
    }

    // When the Load Data button is clicked, update the data URL.
    document.getElementById("loadButton").addEventListener("click", () => {
      const input = document.getElementById("dataUrlInput");
      if (input && input.value) {
        ReactDOM.render(<MoleculeViewer dataUrl={input.value} />, document.getElementById("root"));
      }
    });

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
