<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Molecule Viewer</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .top-bar {
      background: #f2f2f2;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid #ddd;
    }
    .top-bar input {
      width: 80%;
      padding: 5px;
      font-size: 14px;
    }
    .top-bar button {
      padding: 5px 10px;
      font-size: 14px;
    }
    .container {
      width: 90%;
      margin: auto;
      padding: 20px 20px; /* ensure left/right padding */
    }
    .molecule-row {
      display: flex;
      flex-direction: row;
      gap: 20px;
      margin-bottom: 20px;
      padding: 10px;
      padding-right: 20px; /* add gap on right */
      border-bottom: 1px solid #ddd;
      align-items: flex-start;
    }
    .molecule-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 150px;
      cursor: pointer;
    }
    /* Render each canvas at intrinsic 300x300 for high resolution, but displayed at 150x150 */
    .molecule-canvas {
      width: 150px;
      height: 150px;
    }
    .score,
    .header-text {
      font-size: 12px;
      color: gray;
      margin-bottom: 5px;
    }
    .header-text {
      font-weight: normal;
    }
    .smiles-text {
      font-size: 12px;
      margin-top: 5px;
      text-align: center;
      word-break: break-all;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <!-- Using value attribute so the default URL appears on load -->
    <input id="dataUrlInput" type="text" value="./work/001_big/lambda/20250309-220000/translation/tgt-test_n1000.txt__model_step_250000__n_best=10__beam_size=100.txt.json" />
    <button id="loadButton">Load Data</button>
  </div>
  <div id="root"></div>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/smiles-drawer@2.0.1/dist/smiles-drawer.min.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Fallback data with simple, short SMILES.
    // (Second hypothesis in the first entry is intentionally invalid.)
    const fallbackData = [
      {
        sent: "C 6 H 6",
        ref: "C1=CC=CC=C1",
        hyps: [
          { score: -0.1, pred: "C1=CC=CC=C1" },
          { score: -0.2, pred: "InvalidSMILES" }
        ]
      },
      {
        sent: "C 2 H 5 OH",
        ref: "CCO",
        hyps: [
          { score: -0.05, pred: "CCO" },
          { score: -0.08, pred: "C-C-O" }
        ]
      }
    ];

    // Helper: Draw an error message on a canvas.
    const drawError = (canvas, msg) => {
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.font = "14px Arial";
      ctx.fillStyle = "red";
      ctx.textAlign = "center";
      ctx.fillText(msg, canvas.width / 2, canvas.height / 2);
    };

    // MoleculeCard component renders its own canvas and shows a "Loading..." overlay.
    const MoleculeCard = ({ smiles, score, isPrediction, header, correct, openExternalViewer }) => {
      const canvasRef = useRef(null);
      const [loaded, setLoaded] = useState(false);

      useEffect(() => {
        setLoaded(false);
        const canvas = canvasRef.current;
        if (canvas) {
          const drawer = new SmilesDrawer.Drawer({ width: 300, height: 300 });
          SmilesDrawer.parse(
            smiles,
            (tree) => {
              drawer.draw(tree, canvas, "light");
              setLoaded(true);
            },
            (err) => {
              console.warn("Error parsing SMILES:", smiles, err);
              drawError(canvas, "Invalid SMILES");
              setLoaded(true);
            }
          );
        }
      }, [smiles]);

      return (
        <div className="molecule-card" onClick={() => openExternalViewer(smiles)}>
          {header && <div className="header-text">{header}</div>}
          {isPrediction && !header && <div className="score">{score}</div>}
          <div style={{ position: "relative", width: "150px", height: "150px" }}>
            <canvas
              ref={canvasRef}
              className="molecule-canvas"
              width="300" height="300"
              style={{
                border: correct ? "4px solid green" : "2px solid black",
                marginTop: correct ? "-2px" : "0",
                width: "150px",
                height: "150px"
              }}
            ></canvas>
            {!loaded && (
              <div style={{
                position: "absolute",
                top: 0,
                left: 0,
                width: "150px",
                height: "150px",
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                backgroundColor: "rgba(255, 255, 255, 0.8)",
                fontSize: "14px",
                color: "gray"
              }}>
                Loading...
              </div>
            )}
          </div>
          <div className="smiles-text">{smiles}</div>
        </div>
      );
    };

    function MoleculeViewer({ dataUrl }) {
      const [molecules, setMolecules] = useState([]);
      const [page, setPage] = useState(1);
      const containerRef = useRef(null);

      useEffect(() => {
        loadMolecules();
        window.addEventListener("scroll", handleScroll);
        return () => window.removeEventListener("scroll", handleScroll);
      }, [dataUrl]);

      // Load molecules from provided data URL or fallback.
      const loadMolecules = async () => {
        try {
          const response = await fetch(dataUrl);
          if (!response.ok) throw new Error("Failed to load");
          const data = await response.json();
          setMolecules(data); // Store full dataset.
          setPage(1);
        } catch (error) {
          console.warn("Using fallback data:", error);
          setMolecules(fallbackData);
          setPage(1);
        }
      };

      // Load 5 rows at a time.
      const handleScroll = () => {
        if (window.innerHeight + window.scrollY >= document.documentElement.scrollHeight - 100) {
          setPage(prev => prev + 1);
        }
      };

      useEffect(() => {
        if (molecules.length > 0) {
          // Redraw molecules when page increases.
          // (Our MoleculeCard components handle their own drawing.)
        }
      }, [molecules, page]);

      // Open PubChem with the given SMILES.
      const openExternalViewer = (smiles) => {
        const url = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${encodeURIComponent(smiles)}/PNG`;
        window.open(url, "_blank");
      };

      return (
        <div className="container" ref={containerRef}>
          {molecules.slice(0, page * 5).map((mol, index) => (
            <div key={index} className="molecule-row">
              {/* Reference card with header */}
              <MoleculeCard
                smiles={(mol.ref || "").replace(/\s+/g, "")}
                header="Reference"
                openExternalViewer={openExternalViewer}
              />
              {/* Prediction cards: only first 4 */}
              {mol.hyps && mol.hyps.slice(0, 4).map((hyp, hIdx) => (
                <MoleculeCard
                  key={hIdx}
                  smiles={(hyp.pred || "").replace(/\s+/g, "")}
                  score={hyp.score}
                  isPrediction={true}
                  openExternalViewer={openExternalViewer}
                  correct={ (hyp.pred || "").replace(/\s+/g, "") === (mol.ref || "").replace(/\s+/g, "") }
                />
              ))}
            </div>
          ))}
        </div>
      );
    }

    function App() {
      const defaultUrl = "./work/001_big/lambda/20250309-220000/translation/tgt-test_n1000.txt__model_step_250000__n_best=10__beam_size=100.txt.json";
      const [dataUrl, setDataUrl] = useState(defaultUrl);

      return (
        <MoleculeViewer dataUrl={dataUrl} />
      );
    }

    // When the Load Data button is clicked, update the data URL.
    document.getElementById("loadButton").addEventListener("click", () => {
      const input = document.getElementById("dataUrlInput");
      if (input && input.value) {
        ReactDOM.render(<MoleculeViewer dataUrl={input.value} />, document.getElementById("root"));
      }
    });

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
